<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos - Admin</title>
    <style>
        /* ESTILOS COMPARTIDOS DEL SIDEBAR */
        :root { --primary: #042490; --primary-gradient: linear-gradient(135deg, #021B79 0%, #0575E6 100%); --bg-page: #F8FAFC; --text-dark: #1E293B; --text-light: #64748B; --success: #10B981; --danger: #EF4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg-page); color: var(--text-dark); display: flex; min-height: 100vh; }
        
        .sidebar { width: 280px; background: var(--primary-gradient); color: white; padding: 30px 20px; display: flex; flex-direction: column; box-shadow: 4px 0 20px rgba(0,0,0,0.1); position: sticky; top: 0; height: 100vh; }
        .logo { font-size: 22px; font-weight: 800; margin-bottom: 50px; display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 16px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); }
        .nav-group { display: flex; flex-direction: column; gap: 10px; flex: 1; }
        .nav-item { padding: 14px 20px; color: rgba(255,255,255,0.7); text-decoration: none; border-radius: 14px; transition: 0.3s; font-weight: 600; font-size: 15px; display: flex; align-items: center; gap: 12px; border: 1px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.15); color: white; transform: translateX(5px); }
        .nav-item.active { background: white; color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: 800; }
        .nav-footer { margin-top: auto; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px; }

        .main-content { flex: 1; padding: 40px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 28px; font-weight: 800; }

        .btn-add { background: var(--success); color: white; border: none; padding: 12px 24px; border-radius: 12px; cursor: pointer; font-weight: 700; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); transition: 0.2s; }
        .btn-add:hover { transform: translateY(-2px); }

        .card { background: white; border-radius: 20px; padding: 0; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 20px; background: #F8FAFC; color: var(--text-light); font-size: 12px; text-transform: uppercase; font-weight: 700; }
        td { padding: 15px 20px; border-bottom: 1px solid #F1F5F9; vertical-align: middle; }
        
        .product-thumb { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; background: #F1F5F9; }
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; cursor: pointer; }
        .in-stock { background: #D1FAE5; color: #065F46; }
        .out-stock { background: #FEE2E2; color: #991B1B; }
        
        .btn-icon { background: none; border: none; font-size: 18px; cursor: pointer; padding: 8px; border-radius: 8px; transition: 0.2s; }
        .btn-icon:hover { background: #F1F5F9; }
        
        /* MODAL (Estilos del anterior c√≥digo, mantenidos) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-card { background: white; padding: 30px; border-radius: 20px; width: 450px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; color: #64748B; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 14px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .btn-cancel { background: #F1F5F9; color: #64748B; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">üî• Admin Panel</div>
        <div class="nav-group">
            <a href="E6F1.html" class="nav-item"><span>üìä</span> Dashboard</a>
            <a href="E6F3.html" class="nav-item active"><span>ü•©</span> Productos</a>
            <a href="E6F2.html" class="nav-item"><span>üìÖ</span> Reservas</a>
        </div>
        <div class="nav-footer">
            <a href="E2F1.html" class="nav-item" target="_blank" style="background: rgba(255,255,255,0.1);"><span>üåê</span> Ver Tienda</a>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h2 class="page-title">Cat√°logo de Productos</h2>
            <button class="btn-add" onclick="openModal()">+ Nuevo Producto</button>
        </div>

        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>Img</th>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th>Categor√≠a</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="productsTable">
                    <tr><td colspan="6" style="text-align:center; padding:30px;">Cargando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-card">
            <h3 style="margin-bottom:20px; font-weight:800; color:var(--primary)" id="modalTitle">Agregar Producto</h3>
            <div class="form-group"><label class="form-label">Nombre</label><input type="text" id="pName" class="form-input"></div>
            <div class="form-group"><label class="form-label">Descripci√≥n</label><input type="text" id="pDesc" class="form-input"></div>
            <div class="form-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div><label class="form-label">Precio</label><input type="number" id="pPrice" class="form-input"></div>
                <div><label class="form-label">Categor√≠a</label><select id="pCat" class="form-input"><option value="carnes">Carnes</option><option value="combos">Combos Parrilleros</option> <option value="carnes">Carnes</option><option value="acompa√±amientos">Acompa√±amientos</option><option value="bebidas">Bebidas</option><option value="postres">Postres</option></select></div>
            </div>
            <div class="form-group"><label class="form-label">URL Imagen</label><input type="text" id="pImg" class="form-input"></div>
            <div class="form-group"><label class="form-label"><input type="checkbox" id="pOferta"> ¬øEs Oferta?</label></div>
            <div class="modal-actions"><button class="btn-cancel" onclick="closeModal()">Cancelar</button><button class="btn-save" onclick="saveProduct()">Guardar</button></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';
        let productosGlobal = []; 
        let editingProductId = null; 

        document.addEventListener('DOMContentLoaded', loadProducts);

        async function loadProducts() {
            const tbody = document.getElementById('productsTable');
            try {
                const res = await fetch(`${API_URL}/products?t=${Date.now()}`);
                productosGlobal = await res.json();
                tbody.innerHTML = '';
                
                productosGlobal.forEach(p => {
                    const imgUrl = (p.imagen && p.imagen.startsWith('http')) ? p.imagen : 'https://via.placeholder.com/40?text=P';
                    const enStock = p.disponible !== false; 
                    const badgeClass = enStock ? 'in-stock' : 'out-stock';
                    const badgeText = enStock ? 'En Stock' : 'Agotado';

                    tbody.innerHTML += `
                        <tr>
                            <td><img src="${imgUrl}" class="product-thumb"></td>
                            <td><strong>${p.nombre}</strong></td>
                            <td>$${p.precio.toLocaleString()}</td>
                            <td style="text-transform:capitalize;">${p.categoria}</td>
                            <td><span class="badge ${badgeClass}" onclick="toggleStock('${p._id}', ${enStock})">${badgeText}</span></td>
                            <td>
                                <button class="btn-icon" onclick="openEditModal('${p._id}')">‚úèÔ∏è</button>
                                <button class="btn-icon" style="color:#EF4444;" onclick="deleteProduct('${p._id}')">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (e) { console.error(e); }
        }

        // Funciones de l√≥gica (Iguales a la versi√≥n anterior funcional)
        function openModal() { editingProductId = null; document.getElementById('modalTitle').textContent = "Agregar Producto"; document.getElementById('pName').value = ''; document.getElementById('pDesc').value = ''; document.getElementById('pPrice').value = ''; document.getElementById('pImg').value = ''; document.getElementById('pOferta').checked = false; document.getElementById('modal').style.display = 'flex'; }
        function openEditModal(id) { const p = productosGlobal.find(prod => prod._id === id); if (!p) return; document.getElementById('pName').value = p.nombre; document.getElementById('pDesc').value = p.descripcion; document.getElementById('pPrice').value = p.precio; document.getElementById('pCat').value = p.categoria; document.getElementById('pImg').value = p.imagen; document.getElementById('pOferta').checked = p.es_oferta; editingProductId = id; document.getElementById('modalTitle').textContent = "Editar Producto"; document.getElementById('modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        
        async function saveProduct() {
            const data = { nombre: document.getElementById('pName').value, descripcion: document.getElementById('pDesc').value, precio: parseInt(document.getElementById('pPrice').value), categoria: document.getElementById('pCat').value, imagen: document.getElementById('pImg').value, es_oferta: document.getElementById('pOferta').checked, disponible: true };
            try {
                let url = `${API_URL}/products`; let method = 'POST';
                if (editingProductId) { url = `${API_URL}/products/${editingProductId}`; method = 'PUT'; }
                await fetch(url, { method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                closeModal(); loadProducts();
            } catch (e) { alert("Error al guardar"); }
        }

        async function deleteProduct(id) { if(!confirm("¬øEliminar?")) return; await fetch(`${API_URL}/products/${id}`, { method: 'DELETE' }); loadProducts(); }
        async function toggleStock(id, estado) { await fetch(`${API_URL}/products/${id}/stock?disponible=${!estado}`, { method: 'PATCH' }); loadProducts(); }
    </script>
</body>
</html>