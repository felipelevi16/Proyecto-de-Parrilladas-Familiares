<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login - Parrilladas Familiares</title>
<style>
  body {
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #f6f5f3, #042490);
    height: 100vh; 
    margin: 0;
  }
  .form-box {
    background: #fff; 
    padding: 25px; 
    border-radius: 12px;
    width: 320px; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    text-align: center;
  }
  .form-box h1 {
    color: #042490;
    margin-bottom: 10px;
  }
  .form-box p {
    margin-bottom: 20px;
    color: #555;
  }
  form {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }
  input[type="email"],
  input[type="password"] {
    width: 85%;
    padding: 10px;
    margin: 8px 0;
    border: 2px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    text-align: center; 
    box-sizing: border-box;
  }
  label {
    width: 85%;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
    font-size: 14px;
    color: #444;
  }
  button {
    width: 85%;
    padding: 10px;
    margin-top: 15px;
    border: none;
    border-radius: 8px;
    background: #06048a;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s;
  }
  button:hover {
    background: #0eabc7;
  }
  small {
    color: #e74c3c;
    display: block;
    height: 14px;
    text-align: left;
    width: 85%;
    margin-bottom: 5px;
  }
  .mensaje {
    margin-top: 15px;
    padding: 10px;
    border-radius: 8px;
    font-weight: 600;
    display: none;
    width: 85%;
    margin-left: auto;
    margin-right: auto;
  }
  .exito {
    background: #2ecc71; 
    color: #fff;
  }
  .error {
    background: #e74c3c; 
    color: #fff;
  }
  .nav {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
  }
  .nav-btn {
    flex: 1;
    padding: 8px;
    margin: 0 5px;
    border: none;
    border-radius: 5px;
    background: #ddd;
    cursor: pointer;
    font-size: 14px;
  }
  .nav-btn.activo {
    background: #06048a;
    color: white;
  }
  .formulario {
    display: none;
  }
  .formulario.activo {
    display: block;
  }
</style>
</head>
<body>
<div class="form-box">
  <div class="nav">
    <button class="nav-btn activo" onclick="mostrarForm('login')">Login</button>
    <button class="nav-btn" onclick="mostrarForm('registro')">Registro</button>
  </div>
  
  <div id="login" class="formulario activo">
    <h1>PARRILLADAS FAMILIARES DON EDUARDO</h1>
    <p>Iniciar sesión</p>
    
    <form id="loginForm">
      <input type="email" id="loginEmail" placeholder="Correo electrónico" required>
      <input type="password" id="loginPassword" placeholder="Contraseña" required>
      <label><input type="checkbox" id="recordar"> Mantener sesión iniciada</label>
      <button type="submit">Ingresar</button>
    </form>
    
    <div style="margin-top: 15px; font-size: 14px;">
      <p><a href="E1F3.html" style="color: #06048a; text-decoration: none;">¿Olvidaste tu contraseña?</a></p>
    </div>
  </div>

  <div id="registro" class="formulario">
    <h1>PARRILLADAS FAMILIARES DON EDUARDO</h1>
    <p>Crear cuenta nueva</p>
    
    <form id="registroForm">
      <input type="email" id="regEmail" placeholder="Correo electrónico" required>
      <small id="error-email"></small>
      <input type="password" id="regPassword" placeholder="Contraseña" required>
      <small id="error-password"></small>
      <input type="password" id="regConfirm" placeholder="Confirmar contraseña" required>
      <small id="error-confirm"></small>
      <label><input type="checkbox" id="regTerminos"> Acepto términos y condiciones</label>
      <small id="error-terminos"></small>
      <button type="submit">Registrarme</button>
    </form>
  </div>
  
  <div id="mensaje" class="mensaje"></div>
</div>

<script>
// --- 1. LÓGICA DE PESTAÑAS (VISUAL) ---
function mostrarForm(tipo) {
  document.querySelectorAll('.formulario').forEach(f => f.classList.remove('activo'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('activo'));
  
  document.getElementById(tipo).classList.add('activo');
  document.querySelector(`.nav-btn[onclick="mostrarForm('${tipo}')"]`).classList.add('activo');
  document.getElementById('mensaje').style.display = 'none';
}

// --- 2. HERRAMIENTAS DE VALIDACIÓN ---
function validarEmail(e){return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);}
function validarPass(p){return /^(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/.test(p);}
function err(id,txt){document.getElementById(id).textContent=txt;}
function limpiarErrores(){["email","password","confirm","terminos"].forEach(c=>err("error-"+c,""));}

const msj = document.getElementById("mensaje");

// --- 3. LÓGICA DE LOGIN CON REDIRECCIÓN POR ROL ---
document.getElementById("loginForm").addEventListener("submit", async e => {
  e.preventDefault(); 
  msj.style.display = 'none';
  
  const emailVal = document.getElementById("loginEmail").value.trim();
  const passwordVal = document.getElementById("loginPassword").value;

  try {
    const response = await fetch('http://127.0.0.1:8000/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: emailVal, password: passwordVal })
    });

    const resultado = await response.json();

    if (response.ok) {
      msj.textContent = "¡Bienvenido! Redirigiendo..."; 
      msj.className = "mensaje exito";
      msj.style.display = "block";
      
      // Guardamos info útil en el navegador
      localStorage.setItem('userEmail', resultado.email);
      localStorage.setItem('userRole', resultado.role);

      // --- AQUÍ ESTÁ LA SOLUCIÓN ---
      setTimeout(() => {
        console.log("Rol detectado:", resultado.role); // Para depurar si hace falta

        if (resultado.role === 'admin') {
            // SI ES ADMIN -> Va al Panel de Control
            window.location.href = "E6F1.html"; 
        } else {
            // SI ES CLIENTE (o cualquier otro) -> Va al Menú Principal
            window.location.href = "E2F1.html"; 
        }
      }, 1500);
      
    } else {
      msj.textContent = resultado.detail || "Credenciales incorrectas";
      msj.className = "mensaje error";
      msj.style.display = "block";
    }
  } catch (error) {
    console.error(error);
    msj.textContent = "Error de conexión.";
    msj.className = "mensaje error";
    msj.style.display = "block";
  }
});

// --- 4. LÓGICA DE REGISTRO (CONECTADO A API Y REDIRECCIÓN) ---
document.getElementById("registroForm").addEventListener("submit", async e => {
  e.preventDefault(); 
  limpiarErrores(); 
  msj.style.display="none";

  const emailVal = document.getElementById("regEmail").value.trim();
  const passVal = document.getElementById("regPassword").value;
  const confVal = document.getElementById("regConfirm").value;
  const termVal = document.getElementById("regTerminos").checked;
  
  let errores = false;

  if(!emailVal || !validarEmail(emailVal)){ err("error-email","Correo inválido"); errores=true; }
  if(!passVal || !validarPass(passVal)){ err("error-password","Contraseña débil"); errores=true; }
  if(confVal !== passVal){ err("error-confirm","No coinciden"); errores=true; }
  if(!termVal){ err("error-terminos","Debes aceptar"); errores=true; }
  
  if(errores) return;

  try {
    const response = await fetch('http://127.0.0.1:8000/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: emailVal,
        password: passVal,
        confirm: confVal,
        terminos: termVal
      })
    });

    const resultado = await response.json();

    if (response.ok) {
      msj.textContent = "¡Cuenta creada! Ingresando...";
      msj.className = "mensaje exito"; 
      msj.style.display = "block";
      document.getElementById("registroForm").reset();
      
      // Redirección automática al menú también después del registro
      setTimeout(() => {
          window.location.href = "E2F1.html";
      }, 2000);
      
    } else {
      msj.textContent = resultado.detail;
      msj.className = "mensaje error"; 
      msj.style.display = "block";
    }
  } catch (error) {
    msj.textContent = "Error de conexión.";
    msj.className = "mensaje error"; 
    msj.style.display = "block";
  }
});
</script>
</body>
</html>