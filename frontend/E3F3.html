<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - Parrilladas</title>
    <style>
        :root {
            /* Paleta Blue Royal */
            --primary: #042490;
            --primary-gradient: linear-gradient(135deg, #021B79 0%, #0575E6 100%);
            --secondary: #FFFFFF;
            --text-dark: #1E293B;
            --text-light: #64748B;
            --bg-page: #F8FAFC;
            --glass: rgba(255, 255, 255, 0.95);
            --success: #10B981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg-page); color: var(--text-dark); }
        
        /* HEADER */
        .header { 
            background: var(--primary); 
            color: white; 
            padding: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            position: sticky; top: 0; z-index: 100;
        }
        .header-content {
            max-width: 1100px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;
        }
        .header h2 { font-size: 20px; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 10px; }
        .back-link { color: rgba(255,255,255,0.8); text-decoration: none; font-size: 14px; font-weight: 600; transition: 0.3s; }
        .back-link:hover { color: white; transform: translateX(-3px); }

        /* LAYOUT */
        .container { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
        .checkout-layout { display: grid; grid-template-columns: 1.5fr 1fr; gap: 40px; align-items: start; }
        
        /* TARJETAS (SECCIONES) */
        .section-card { 
            background: white; border-radius: 20px; padding: 30px; margin-bottom: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02);
        }
        .section-title { 
            font-size: 18px; font-weight: 700; color: var(--text-dark); margin-bottom: 25px; 
            display: flex; align-items: center; gap: 15px; 
        }
        .step-number { 
            background: var(--primary-gradient); color: white; width: 32px; height: 32px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 14px; font-weight: 800; box-shadow: 0 4px 10px rgba(4, 36, 144, 0.2);
        }

        /* OPCIONES (RADIOS) */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .radio-card { 
            border: 2px solid #F1F5F9; border-radius: 16px; padding: 20px; cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
            display: flex; flex-direction: column; align-items: center; text-align: center; 
            background: white;
        }
        .radio-card:hover { transform: translateY(-3px); border-color: #E2E8F0; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .radio-card.selected { 
            border-color: var(--primary); background-color: #F8FAFC; 
            box-shadow: 0 0 0 4px rgba(4, 36, 144, 0.05);
        }
        
        .radio-icon { font-size: 32px; margin-bottom: 10px; }
        .radio-card strong { font-size: 15px; color: var(--text-dark); }
        .radio-card small { font-size: 13px; color: var(--text-light); margin-top: 5px; }
        
        /* FORMULARIOS */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-dark); }
        .form-control { 
            width: 100%; padding: 12px 15px; border: 2px solid #F1F5F9; border-radius: 12px; 
            font-size: 15px; color: var(--text-dark); transition: 0.3s; background: #FAFAFA;
        }
        .form-control:focus { outline: none; border-color: var(--primary); background: white; }
        .hidden { display: none; }

        /* RESUMEN LATERAL (Sticky) */
        .summary-card { 
            position: sticky; top: 100px; background: white; border-radius: 24px; padding: 30px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.02);
        }
        .summary-title { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 20px; }
        
        .summary-items { max-height: 250px; overflow-y: auto; margin-bottom: 25px; padding-right: 5px; }
        .summary-item { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 14px; align-items: center; }
        .item-img { width: 45px; height: 45px; background: #F1F5F9; border-radius: 10px; object-fit: cover; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .item-details { flex: 1; margin-left: 15px; }
        .item-name { font-weight: 600; color: var(--text-dark); display: block; margin-bottom: 2px; }
        .item-qty { font-size: 12px; color: var(--text-light); }
        
        .totals-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 15px; color: var(--text-light); }
        .total-final { 
            font-size: 28px; font-weight: 800; color: var(--primary); margin-top: 25px; 
            border-top: 2px dashed #E2E8F0; padding-top: 20px; display: flex; justify-content: space-between; align-items: center;
        }

        .btn-pay { 
            background: var(--success); color: white; border: none; padding: 18px; width: 100%; 
            border-radius: 16px; font-size: 18px; font-weight: 700; cursor: pointer; margin-top: 25px; 
            transition: all 0.3s; box-shadow: 0 10px 25px rgba(16, 185, 129, 0.25);
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-pay:hover { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(16, 185, 129, 0.35); }
        .btn-pay:disabled { background: #CBD5E1; cursor: not-allowed; box-shadow: none; transform: none; }
        
        .secure-badge { text-align: center; margin-top: 15px; font-size: 12px; color: var(--text-light); display: flex; align-items: center; justify-content: center; gap: 5px; }

        .notification { position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 15px 25px; border-radius: 12px; display: none; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.2); font-weight: 600; }

        @media (max-width: 900px) { .checkout-layout { grid-template-columns: 1fr; } .summary-card { position: static; margin-top: 20px; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-content">
            <h2> Finalizar Compra</h2>
            <a href="E3F2.html" class="back-link">‚Üê Volver al Carrito</a>
        </div>
    </div>

    <div class="container checkout-layout">
        
        <div class="main-content">
            
            <div class="section-card">
                <div class="section-title"><span class="step-number">1</span> Informaci√≥n de Contacto</div>
                <div class="form-group">
                    <label class="form-label">Tel√©fono m√≥vil</label>
                    <input type="tel" id="telefonoInput" class="form-control" placeholder="+56 9 1234 5678" value="+569">
                </div>
            </div>

            <div class="section-card">
                <div class="section-title"><span class="step-number">2</span> M√©todo de Entrega</div>
                <div class="options-grid">
                    <div class="radio-card selected" id="optRetiro" onclick="selMetodo('retiro')">
                        <div class="radio-icon">üè™</div>
                        <strong>Retiro en Local</strong>
                        <small>Gratis</small>
                    </div>
                    <div class="radio-card" id="optDelivery" onclick="selMetodo('delivery')">
                        <div class="radio-icon">üõµ</div>
                        <strong>Delivery</strong>
                        <small>+ $5.000</small>
                    </div>
                </div>

                <div id="pickupForm" style="margin-top: 25px;">
                    <div class="form-group">
                        <label class="form-label">Selecciona Sucursal</label>
                        <select class="form-control" id="sucursalInput">
                            <option value="Las Condes">Las Condes (Av. Las Condes 1234)</option>
                            <option value="Vitacura">Vitacura (Av. Vitacura 5678)</option>
                        </select>
                    </div>
                </div>

                <div id="deliveryForm" class="hidden" style="margin-top: 25px;">
                    <div class="form-group">
                        <label class="form-label">Direcci√≥n de env√≠o</label>
                        <input type="text" id="direccionInput" class="form-control" placeholder="Calle, n√∫mero y depto">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Comuna</label>
                        <select class="form-control" id="comunaInput">
                            <option>Las Condes</option>
                            <option>Vitacura</option>
                            <option>Providencia</option>
                            <option>√ëu√±oa</option>
                            <option>La Reina</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-title"><span class="step-number">3</span> M√©todo de Pago</div>
                <div class="options-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="radio-card selected" id="payWebpay" onclick="selPago('WebPay')">
                        <div class="radio-icon">üí≥</div>
                        <strong>WebPay</strong>
                    </div>
                    <div class="radio-card" id="payTransfer" onclick="selPago('Transferencia')">
                        <div class="radio-icon">üè¶</div>
                        <strong>Transferencia</strong>
                    </div>
                    <div class="radio-card" id="payCash" onclick="selPago('Efectivo')">
                        <div class="radio-icon">üíµ</div>
                        <strong>Efectivo</strong>
                    </div>
                </div>
            </div>

        </div>

        <div class="sidebar">
            <div class="summary-card">
                <div class="summary-title">Resumen del Pedido</div>
                
                <div class="summary-items" id="summaryList">
                    </div>

                <div class="totals-row">
                    <span>Subtotal</span>
                    <span id="resSubtotal" style="font-weight:600; color:var(--text-dark);">$0</span>
                </div>
                <div class="totals-row">
                    <span>Env√≠o</span>
                    <span id="resEnvio" style="font-weight:600; color:var(--text-dark);">$0</span>
                </div>
                
                <div class="total-final">
                    <span style="font-size:18px; color:var(--text-light); font-weight:600;">Total a pagar</span>
                    <span id="resTotal">$0</span>
                </div>

                <button class="btn-pay" onclick="confirmarPedido()">
                    PAGAR AHORA ‚ûî
                </button>
                
                <div class="secure-badge">
                    üîí Pago procesado de forma 100% segura
                </div>
            </div>
        </div>

    </div>

    <div class="notification" id="notification"></div>

    <script>
        let metodoEntrega = 'retiro';
        let metodoPago = 'WebPay';
        const COSTO_ENVIO = 5000;
        let carrito = JSON.parse(localStorage.getItem('carrito')) || [];

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            renderResumen();
        });

        function selMetodo(metodo) {
            metodoEntrega = metodo;
            
            // UI
            document.getElementById('optRetiro').classList.toggle('selected', metodo === 'retiro');
            document.getElementById('optDelivery').classList.toggle('selected', metodo === 'delivery');
            
            // Formularios
            document.getElementById('pickupForm').classList.toggle('hidden', metodo !== 'retiro');
            document.getElementById('deliveryForm').classList.toggle('hidden', metodo !== 'delivery');

            // Recalcular Total (Env√≠o)
            renderResumen();
        }

        function selPago(pago) {
            metodoPago = pago;
            
            // Reset UI
            ['payWebpay', 'payTransfer', 'payCash'].forEach(id => {
                document.getElementById(id).classList.remove('selected');
            });
            
            // Select active
            if(pago === 'WebPay') document.getElementById('payWebpay').classList.add('selected');
            if(pago === 'Transferencia') document.getElementById('payTransfer').classList.add('selected');
            if(pago === 'Efectivo') document.getElementById('payCash').classList.add('selected');
        }

        function renderResumen() {
            const list = document.getElementById('summaryList');
            list.innerHTML = '';
            
            let subtotal = 0;

            carrito.forEach(prod => {
                const totalItem = prod.precio * prod.cantidad;
                subtotal += totalItem;
                
                // Imagen o Emoji
                let imgHTML = prod.imagen && prod.imagen.startsWith('http') 
                    ? `<img src="${prod.imagen}" class="item-img">`
                    : `<div class="item-img">ü•©</div>`;

                list.innerHTML += `
                    <div class="summary-item">
                        <div style="display:flex; align-items:center;">
                            ${imgHTML}
                            <div class="item-details">
                                <span class="item-name">${prod.nombre}</span>
                                <span class="item-qty">Cant: ${prod.cantidad}</span>
                            </div>
                        </div>
                        <div style="font-weight:700;">$${totalItem.toLocaleString()}</div>
                    </div>
                `;
            });

            // C√°lculos
            const costoEnvio = metodoEntrega === 'delivery' ? COSTO_ENVIO : 0;
            const total = subtotal + costoEnvio;

            // Render Totales
            document.getElementById('resSubtotal').textContent = `$${subtotal.toLocaleString()}`;
            document.getElementById('resEnvio').textContent = metodoEntrega === 'delivery' ? `$${COSTO_ENVIO.toLocaleString()}` : 'Gratis';
            document.getElementById('resTotal').textContent = `$${total.toLocaleString()}`;
        }

        async function confirmarPedido() {
            // Validaciones
            const telefono = document.getElementById('telefonoInput').value;
            if(!telefono || telefono.length < 8) {
                alert("Por favor ingresa un tel√©fono v√°lido");
                return;
            }
            if(metodoEntrega === 'delivery' && !document.getElementById('direccionInput').value) {
                alert("Por favor ingresa una direcci√≥n de env√≠o");
                return;
            }

            // Preparar Datos
            const subtotal = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            const envio = metodoEntrega === 'delivery' ? COSTO_ENVIO : 0;
            
            const itemsParaApi = carrito.map(item => ({
                producto_id: item._id,
                cantidad: item.cantidad,
                nombre: item.nombre,
                precio: item.precio
            }));

            const datosPedido = {
                items: itemsParaApi,
                subtotal: subtotal,
                envio: envio,
                descuento: 0,
                total: subtotal + envio,
                metodo_entrega: metodoEntrega,
                user_email: userEmail,
                metodo_pago: metodoPago, 
                sucursal: metodoEntrega === 'retiro' ? document.getElementById('sucursalInput').value : null,
                direccion: metodoEntrega === 'delivery' ? document.getElementById('direccionInput').value : null,
                estado: "Ingresado"
                
            };

            // Enviar a API
            try {
                const btn = document.querySelector('.btn-pay');
                btn.textContent = "Procesando...";
                btn.disabled = true;

                const response = await fetch('http://127.0.0.1:8000/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosPedido)
                });

                const resultado = await response.json();

                if (response.ok) {
                    localStorage.removeItem('carrito');
                    localStorage.setItem('ultimoPedidoId', resultado.id);
                    
                    const notif = document.getElementById('notification');
                    notif.textContent = `¬°Pago Exitoso! Pedido #${resultado.id} confirmado.`;
                    notif.style.display = 'block';
                    
                    setTimeout(() => {
                        window.location.href = 'E7F2.html'; // Ir a Seguimiento
                    }, 2000);
                } else {
                    throw new Error(JSON.stringify(resultado));
                }

            } catch (error) {
                console.error(error);
                alert("Hubo un error al procesar el pedido. Intenta nuevamente.");
                const btn = document.querySelector('.btn-pay');
                btn.innerHTML = "PAGAR AHORA ‚ûî";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>