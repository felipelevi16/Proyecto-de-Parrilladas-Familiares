<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrega - Parrilladas</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif}
        body{background:#f8f9fa;color:#333}
        .header{background:#042490;color:white;padding:15px}
        .nav{display:flex;justify-content:space-between;align-items:center;max-width:800px;margin:0 auto}
        .nav a{color:white;text-decoration:none}
        .container{max-width:800px;margin:0 auto;padding:20px}
        .progress-bar{display:flex;justify-content:space-between;margin:20px 0}
        .step-circle{width:30px;height:30px;border-radius:50%;background:white;border:2px solid #ddd;display:flex;align-items:center;justify-content:center;margin:0 auto 5px;font-weight:bold}
        .step-circle.active{border-color:#042490;background:#042490;color:white}
        .delivery-options{background:white;border-radius:8px;padding:20px;margin-bottom:20px;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
        .radio-option{padding:15px;border:2px solid #eee;border-radius:8px;cursor:pointer;margin-bottom:10px}
        .radio-option.selected{border-color:#042490;background:#fff9f9}
        .form-section{background:#f9f9f9;padding:15px;border-radius:8px;margin-top:15px;display:none}
        .form-section.active{display:block}
        .form-group{margin-bottom:15px}
        .form-control{width:100%;padding:10px;border:1px solid #ddd;border-radius:4px}
        .action-buttons{display:flex;gap:10px;margin-top:20px}
        .btn{padding:12px 20px;border:none;border-radius:4px;cursor:pointer;flex:1;text-align:center;text-decoration:none;font-weight:bold;color:white;background:#042490;}
        .btn:hover{background:#0eabc7;}
        .btn-secondary{background:#6c757d;}
        .notification{position:fixed;top:20px;right:20px;background:#27ae60;color:white;padding:15px;border-radius:8px;display:none;z-index:1000;}
    </style>
</head>
<body>
    <div class="header">
        <div class="nav">
            <div>ü•© Parrilladas</div>
            <div><a href="E3F2.html">‚Üê Volver al Carrito</a></div>
        </div>
    </div>
    
    <div class="container">
        <h2 style="text-align:center;color:#042490;margin:20px 0">Finalizar Pedido</h2>
        
        <div class="delivery-options">
            <div style="margin-bottom:15px;font-weight:bold">M√©todo de entrega:</div>
            
            <div class="radio-option selected" id="optRetiro" onclick="selMetodo('retiro')">
                <div style="font-weight:bold">Retiro en Local (Gratis)</div>
            </div>
            
            <div class="radio-option" id="optDelivery" onclick="selMetodo('delivery')">
                <div style="font-weight:bold">Delivery a Domicilio (+$5.000)</div>
            </div>
            
            <div id="pickupForm" class="form-section active">
                <div class="form-group">
                    <label>Sucursal:</label>
                    <select class="form-control" id="sucursalInput">
                        <option value="vitacura">Vitacura</option>
                        <option value="las-condes">Las Condes</option>
                    </select>
                </div>
            </div>
            
            <div id="deliveryForm" class="form-section">
                <div class="form-group">
                    <label>Direcci√≥n:</label>
                    <input type="text" class="form-control" id="direccionInput" placeholder="Calle y n√∫mero">
                </div>
                <div class="form-group">
                    <label>Comuna:</label>
                    <select class="form-control" id="comunaInput">
                        <option value="vitacura">Vitacura</option>
                        <option value="las-condes">Las Condes</option>
                        <option value="providencia">Providencia</option>
                    </select>
                </div>
            </div>

            <div class="form-group" style="margin-top:15px;">
                <label>Tel√©fono de contacto:</label>
                <input type="tel" class="form-control" id="telefonoInput" placeholder="+56 9..." required>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="btn" onclick="confirmarPedido()">CONFIRMAR Y PAGAR</button>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        let metodoSeleccionado = 'retiro';
        const COSTO_ENVIO = 5000;

        function selMetodo(metodo) {
            metodoSeleccionado = metodo;
            
            // Visuales
            document.getElementById('optRetiro').classList.toggle('selected', metodo === 'retiro');
            document.getElementById('optDelivery').classList.toggle('selected', metodo === 'delivery');
            
            document.getElementById('pickupForm').classList.toggle('active', metodo === 'retiro');
            document.getElementById('deliveryForm').classList.toggle('active', metodo === 'delivery');
        }

        async function confirmarPedido() {
            // 1. Validar Datos B√°sicos
            const telefono = document.getElementById('telefonoInput').value;
            if(!telefono) {
                alert("Por favor ingresa un tel√©fono de contacto");
                return;
            }

            // 2. Preparar datos del Carrito
            const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
            if(carrito.length === 0) {
                alert("El carrito est√° vac√≠o");
                window.location.href = 'E2F2.html';
                return;
            }

            // Calcular totales
            const subtotal = carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            const envio = metodoSeleccionado === 'delivery' ? COSTO_ENVIO : 0;
            const total = subtotal + envio;

            // 3. Armar el objeto PEDIDO para la API
            // Nota: Mapeamos los datos para que coincidan con models.py (ProductoEnCarrito)
            const itemsParaApi = carrito.map(item => ({
                producto_id: item._id,
                cantidad: item.cantidad
            }));

            const datosPedido = {
                items: itemsParaApi,
                subtotal: subtotal,
                envio: envio,
                descuento: 0,
                total: total,
                metodo_entrega: metodoSeleccionado,
                sucursal: metodoSeleccionado === 'retiro' ? document.getElementById('sucursalInput').value : null,
                direccion: metodoSeleccionado === 'delivery' ? document.getElementById('direccionInput').value : null,
                estado: "Ingresado"
            };

            // 4. ENVIAR A LA API
            try {
                const notif = document.getElementById('notification');
                notif.textContent = "Procesando pedido...";
                notif.style.display = 'block';

                const response = await fetch('http://127.0.0.1:8000/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datosPedido)
                });

                const resultado = await response.json();

                if (response.ok) {
                    // √âXITO
                    localStorage.removeItem('carrito'); // Vaciamos el carrito
                    notif.style.backgroundColor = "#27ae60";
                    notif.textContent = `¬°√âxito! Pedido #${resultado.id} creado.`;
                    
                    // Redirigir despu√©s de 2 segundos (al home o a seguimiento)
                    setTimeout(() => {
                        window.location.href = 'E2F1.html'; 
                    }, 2000);
                } else {
                    // ERROR API
                    throw new Error(resultado.detail || "Error al crear el pedido");
                }

            } catch (error) {
                console.error(error);
                alert("Error: " + error.message);
                document.getElementById('notification').style.display = 'none';
            }
        }
    </script>
</body>
</html>